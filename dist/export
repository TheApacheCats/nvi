#!/bin/sh
revision=${@:-now}
cvsrev=`echo $revision | sed -e 's/-//;s/\./-/g'`
option="-r $cvsrev"
dir=$revision
version=`echo $revision | sed -e 's/nvi-//'`
date=`date +%Y-%m-%d`
if test "$revision" = now; then 
	dir=vi-current; 
	option="-D now"
	version=current;
fi

cvs export $option -d $dir vi
(cd $dir/dist
    sh distrib --ignore-deps
    rm export
)
(cd $dir/docs
    mkdir html
    for i in edit exref vi.man vi.ref vitut; do 
	(cd $i; 
	 make;
	 rm -f core # grops sometimes dumps core on me
        ); 
    done
)
(cd $dir
    perl -pi -e "s/version 1.80/version $version/" README
    perl -pi -e "s(%H%)($date)" README
)
(cd $dir/ex
    perl -pi -e "s/\\\$Revision: 8.5 $/$version/" version.h
    perl -pi -e "s(%H%)($date)" version.h
)
tar czf $dir.tar.gz $dir
