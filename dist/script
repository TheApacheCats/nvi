# setup
setenv VERSION 
setenv S /usr/src/nvi

# build the docs
cd $S/docs/USD.doc/vi.ref && \
    make clean paper.ps vi.ref.txt && chmod 444 vi.ref.txt vi.ref.ps && \
    rm index index.so
cd $S/docs/USD.doc/vi.man && make clean vi.0 vi.0.ps && chmod 444 vi.0 vi.0.ps

# increment the version numbers
setenv X version.h
cd $S/ex && sco $X && echo "go to $VERSION" | sccs delget $X
setenv X README
cd $S && sco $X && vi $X && echo "go to $VERSION" | sccs delget $X
cd $S/docs && vi changelog

# build the distribution
cd $S/build && sh ./distrib
cd $S/catalog && make clean all check && rm dump && \
    chmod 444 english* *.check

# build a version
cd $S && rm -rf build.local && mkdir build.local && \
    cd build.local && ../build/configure --enable-debug && make
what nvi | gzip > ../../TK/history/$VERSION.gz
chmod 444 ../../TK/history/$VERSION.gz

# cleanup
cd $S && allout
cd $S && mv build.local RCS/
find . -type d \! -perm 775
find . \( -name '*.rej' -o -name '*.orig' \)
find . -name RCS -prune -o -name SCCS -prune -o \
    -type f \( -perm -200 -o -perm -2 -o -perm -20 \)
chown -R bin.wsrc .

# create
cd $S/.. && mv -i nvi nvi-$VERSION
tar cFFf - nvi-$VERSION | gzip --best > /tmp/nvi-$VERSION.tar.gz
chmod 444 /tmp/nvi-$VERSION.tar.gz && mv -i nvi-$VERSION nvi
cd $S && mv -i RCS/build.local build.local
